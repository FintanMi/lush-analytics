# Lush Analytics 需求文档\n
## 1. 应用概述

### 1.1 应用名称
Lush Analytics\n
### 1.2 应用描述
一款轻量级、高性能的分析 API 系统，专为卖家设计。系统提供实时异常检测（销售/点击峰值、机器人检测）、短期趋势预测（流量/销售预测）以及高效可扩展的后端架构，利用 DSP 技术（FIR、FFT、HFD）和概率缓存。增强功能包括自动洞察引擎、预测性警报、卖家健康评分、行为指纹识别能力、确定性可重现性、数据充分性指标、速率限制可见性、决策钩子、每周健康报告、警报驱动的定价层级、专用异常/预测端点、固定层级默认值、洞察摘要、一键导出功能、可嵌入组件、置信度/充分性感知消息传递、可审计配置管理、形式化洞察生命周期、可嵌入防护栏、编码化系统不变量、数据最小化执行、聚合优先分析、基于层级的保留策略、边缘案例检测作为信号质量指标、全面加密策略、Webhook 注册与管理以及漏斗分析。

应用现包含简洁现代的前端界面，具有英雄区、功能展示、定价层级、推荐和电子邮件注册功能，完全响应桌面和移动设备。
\n**新功能**：团队协作系统，具有基于角色的访问控制（管理员/成员）、项目管理、实时任务跟踪、带任务完成进度和分配任务的仪表板，以及 Stripe 支付集成。

## 2. 核心功能

### 2.1 事件摄取
- **端点**：POST /events
- **功能**：实时接受和处理卖家事件数据
- **负载结构**：\n  - sellerId：卖家标识符（仅不透明/代理键）
  - timestamp：事件时间戳（毫秒）
  - type：事件类型（SALE / CLICK / VIEW / CHECKOUT_STARTED / PAYMENT_SUCCEEDED）
  - value：事件值（仅行为信号，无 PII）
- **处理逻辑**：将事件添加到预分配的固定大小环形缓冲区（连续数组），每个卖家每个指标使用单独的缓冲区。使用索引模窗口大小进行循环访问。无每事件重新分配或对象流失。
- **数据最小化**：从事件负载中剥离所有 PII（姓名、电子邮件、地址），仅保留行为信号。
\n### 2.2 批量摄取
- **端点**：POST /events/batch
- **功能**：接受高吞吐量卖家的批量事件数据
- **负载结构**：事件对象数组（已剥离 PII）
- **处理逻辑**：在单个请求中高效处理多个事件以减少开销，使用相同的环形缓冲区机制\n\n### 2.3 环形缓冲区管理
- 预分配的固定大小连续数组（窗口大小在集中配置中定义）
- 索引模窗口大小进行循环访问
- 每事件零重新分配\n- 无每事件对象流失
- 支持实时 FIR、FFT 和 HFD 计算
- **清晰的时间窗口定义**：在 API 响应和 UI 中公开时间窗口参数（开始时间戳、结束时间戳、窗口大小）\n
### 2.4 DSP 分析管道
- **FIR 平滑**：平滑时间序列数据\n- **FFT 分析**：检测销售/点击中的周期性峰值，识别重复的机器人模式或每小时峰值
- **HFD（Higuchi 分形维数）**：测量时间序列复杂性/不规则性，高 HFD 值表示可能的机器人活动或异常行为
- **贝叶斯/概率评分**：结合平滑偏差、FFT 峰值和 HFD 输出异常分数（0-1 范围）\n- **确定性异常可重现性**：通过固定随机种子、确定性排序和一致的计算顺序确保相同输入始终产生相同输出
- **聚合优先**：所有分析都在聚合数据上操作，从不在原始单个事件上操作

### 2.5 具有时间局部性的概率缓存
- 每卖家热指标缓存\n- **lastComputedAt** 时间戳跟踪每个缓存指标
- 仅在查询时进行概率刷新（不是每个事件）
- 在集中配置中定义的自适应 TTL 策略：
  - 热卖家：基于配置 TTL 重新计算
  - 冷卖家：基于配置 TTL 重新计算
- 短期缓存层以减少重复函数调用
- 确保高负载下的系统可扩展性

### 2.6 异常检测 API
- **端点**：GET /metrics/:seller/anomalies
- **功能**：返回卖家异常分数和归因分解
- **响应格式**：
  - anomalyScore：总体异常分数（0-1）
  - attribution：根本原因分解（FFT 峰值贡献、HFD 复杂性贡献、趋势偏差）
  - timeWindow：清晰的时间窗口定义（startTimestamp、endTimestamp、windowSize）
  - dataSufficiency：数据充分性指标（充分/不充分，所需最小数据点，当前可用数据点）
  - reproducibilityHash：用于确定性验证的哈希值
  - confidenceMessage：置信度和充分性感知消息传递，解释结果可靠性
  - configVersion：用于此计算的配置版本
  - signalQuality：信号质量评估（退化模式、边缘案例标志）
\n### 2.7 预测 API
- **端点**：GET /metrics/:seller/predictions
- **功能**：返回预测的销售/流量时间序列数据及置信带
- **响应格式**：
  - predictions：带时间戳的预测值数组
  - confidenceBands：预测周围的 ± 置信区间\n  - historicalCutoff：标记历史结束和预测开始的时间戳
  - timeWindow：清晰的时间窗口定义\n  - dataSufficiency：数据充分性指标\n  - reproducibilityHash：用于确定性验证的哈希值
  - confidenceMessage：置信度和充分性感知消息传递，解释预测可靠性
  - configVersion：用于此计算的配置版本
  - signalQuality：信号质量评估

### 2.8 具有摘要和生命周期管理的自动洞察引擎
- **功能**：基于规则和概率分析生成轻量级洞察
- **输入信号**：
  - 异常分数\n  - FFT 周期性\n  - HFD 复杂性
  - 最近趋势斜率
- **输出**：人类可读的洞察摘要，解释检测到的模式和潜在问题
- **洞察摘要**：简洁、可操作的摘要，便于快速理解
- **洞察生命周期状态**：
  - Generated：新创建的洞察
  - Confirmed：由后续数据或用户操作验证的洞察
  - Expired：由于时间流逝而不再相关的洞察\n  - Superseded：被更新、更准确的洞察取代的洞察
- **状态转换**：基于时间、数据更新和用户反馈的自动状态管理
- **端点**：GET /insights/:seller/lifecycle 查询洞察状态

### 2.9 异常归因（根本原因分解）
- **功能**：解释异常分数组成\n- **组件**：
  - FFT 峰值贡献百分比
  - HFD 复杂性贡献百分比
  - 趋势偏差贡献百分比
  - 平滑偏差贡献百分比
\n### 2.10 具有单一主要触发器的预测性警报
- **功能**：基于主要触发器和上下文信息的主动警报系统
- **主要触发器**：异常分数阈值（在集中配置中定义）
- **上下文信息**：趋势、归因、指纹、时间窗口作为上下文提供，而非额外触发器
- **警报级别**：由配置表定义（数据驱动），而非条件语句
- **警报类型**：潜在峰值警告、下降趋势警报、模式转变通知
- **系统不变量**：所有警报必须引用数据充分性状态

### 2.11 卖家健康评分（综合指数）
- **端点**：GET /metrics/:seller/health
- **功能**：计算综合卖家健康评分\n- **评分因素**：
  - 波动水平
  - 异常频率
  - 预测风险评估
  - 数据一致性指标
- **响应格式**：{ healthScore: 0-100, breakdown: {...}, timeWindow: {...}, dataSufficiency: {...}, confidenceMessage: \"...\", configVersion: \"...\", signalQuality: {...} }

### 2.12 行为指纹识别\n- **功能**：识别和跟踪卖家行为模式
- **分析方法**：
  - FFT + HFD + 时间熵组合
- **检测能力**：
  - 机器人集群识别
  - 重复操纵模式\n  - 突然策略变化
- **输出**：行为指纹签名和模式分类
- **数据最小化**：指纹仅基于聚合行为信号，无 PII

### 2.13 智能采样与自适应分辨率
- **功能**：根据卖家活动自动调整分析计算成本
- **自适应逻辑**（在集中配置中定义）：
  - 高活动卖家：全分辨率分析
  - 中等活动卖家：中等采样\n  - 低活动卖家：降低采样频率
- **优势**：在保持准确性的同时优化系统资源
\n### 2.14 实时仪表板集成
- **技术**：Supabase Realtime 集成
- **功能**：带 AnomalyAlert 组件的实时仪表板更新
- **特性**：
  - 实时异常通知
  - 实时指标更新
  - 带分页/无限滚动的事件日志显示
  - **时间窗口显示**：在 UI 中显示清晰的时间窗口定义（开始时间、结束时间、窗口大小）
  - **数据充分性指标**：显示明确的数据充分性状态（充分/不充分，显示当前与所需数据点的进度条）
  - **速率限制与背压可见性**：显示当前速率限制状态、剩余配额、背压指标和队列深度
  - **置信度与充分性感知消息传递**：根据数据质量显示解释结果可靠性的上下文消息
  - **洞察生命周期显示**：显示洞察状态（Generated、Confirmed、Expired、Superseded）及视觉指标
  - **信号质量指标**：显示边缘案例标志和退化模式警告
  - **任务完成进度**：显示当前用户分配任务的总体完成百分比
  - **分配任务概览**：显示分配给当前用户的任务列表及状态指标

### 2.15 事件日志管理
- **功能**：在仪表板上显示和管理事件日志
- **特性**：
  - 分页支持
  - 无限滚动能力
  - 大量事件的高效数据加载
- **数据最小化**：仅显示聚合行为信号，无 PII
\n### 2.16 决策钩子
- **功能**：为自定义业务逻辑集成提供可扩展的决策钩子
- **钩子点**：
  - 异常检测前钩子：在异常检测前执行自定义逻辑
  - 异常检测后钩子：在异常检测后执行自定义逻辑\n  - 预测前钩子：在预测生成前执行自定义逻辑
  - 预测后钩子：在预测生成后执行自定义逻辑
  - 警报触发钩子：在触发警报时执行自定义逻辑
- **用例**：自定义通知路由、第三方集成、业务规则执行、审计日志记录

### 2.17 每周卖家健康报告
- **功能**：为卖家生成并交付自动化每周健康报告
- **报告内容**：
  - 每周健康评分摘要
  - 异常频率和严重性分解
  - 趋势分析和预测
  - 行为模式洞察
  - 可操作建议
  - 快速理解的洞察摘要
  - 洞察生命周期状态摘要
  - 信号质量评估摘要
- **交付方式**：电子邮件、仪表板通知、用于检索的 API 端点
- **端点**：GET /reports/:seller/weekly\n- **配置快照**：每个报告包含用于生成的配置版本快照

### 2.18 具有固定默认值的警报驱动定价层级
- **功能**：基于警报频率和严重性的动态定价层级系统
- **层级结构**：数据驱动的层级定义（非基于逻辑）
- **每层级固定默认值**：
  - 免费层级：€0 - 标准功能，默认警报阈值，基本洞察，可嵌入组件上的轻品牌水印
  - 基础层级：€50 - 增强功能，较低警报阈值，详细洞察，更快响应，可嵌入组件上的减少品牌\n  - 高级层级：€300 - 高级功能，自定义警报阈值，全面洞察，优先支持，可嵌入组件上的最小品牌
  - 商业层级：€1200 - 完整功能访问，完全自定义警报阈值，企业级洞察，专属支持，可嵌入组件上无品牌
- **定价因素**（在集中配置中定义）：
  - 每月触发的警报数量
  - 异常严重性级别
  - 预测准确性要求
  - 实时处理需求
- **端点**：GET /pricing/:seller/tier

### 2.19 专用异常端点
- **端点**：POST /sell/anomaly\n- **功能**：用于向外部系统销售/公开异常检测结果的专用端点
- **负载结构**：
  - sellerId：卖家标识符（不透明/代理键）
  - timeRange：异常检测的时间范围\n  - includeAttribution：包含根本原因分解的布尔标志
- **响应格式**：\n  - anomalyScore：总体异常分数\n  - attribution：根本原因分解
  - timeWindow：时间窗口定义
  - dataSufficiency：数据充分性指标
  - reproducibilityHash：用于验证的哈希值
  - confidenceMessage：置信度和充分性感知消息传递
  - configVersion：使用的配置版本
  - signalQuality：信号质量评估
\n### 2.20 专用预测端点
- **端点**：POST /sell/prediction
- **功能**：用于向外部系统销售/公开预测结果的专用端点
- **负载结构**：\n  - sellerId：卖家标识符（不透明/代理键）
  - predictionHorizon：要预测的时间步数
  - includeConfidenceBands：包含置信区间的布尔标志\n- **响应格式**：
  - predictions：带时间戳的预测值数组
  - confidenceBands：± 置信区间
  - historicalCutoff：标记历史/预测边界的时间戳
  - timeWindow：时间窗口定义
  - dataSufficiency：数据充分性指标
  - reproducibilityHash：用于验证的哈希值
  - confidenceMessage：置信度和充分性感知消息传递
  - configVersion：使用的配置版本
  - signalQuality：信号质量评估

### 2.21 一键导出功能
- **功能**：一键导出报告、洞察和分析数据
- **导出格式**：PDF、电子邮件\n- **导出内容**：
  - 异常报告
  - 预测报告
  - 健康评分报告
  - 每周健康报告
  - 洞察摘要
  - 用于报告生成的配置快照
- **端点**：\n  - POST /export/pdf：生成并下载 PDF 报告\n  - POST /export/email：通过电子邮件发送报告
\n### 2.22 具有防护栏的可嵌入组件
- **功能**：提供可嵌入的 UI 组件，用于集成到外部仪表板或应用程序\n- **组件**：
  - 异常图表小部件
  - 预测图表小部件
  - 健康评分小部件
  - 警报通知小部件
  - 事件日志小部件
- **集成**：JavaScript SDK 或基于 iframe 的嵌入\n- **自定义**：支持主题自定义和配置选项
- **软防护栏**：\n  - 每嵌入密钥的速率限制（在集中配置中按层级定义）
  - 免费/基础层级的轻品牌水印
  - 默认只读范围（除非明确授予，否则无写访问权限）
  - 需要嵌入密钥身份验证\n
### 2.23 可审计配置管理
- **功能**：跟踪和审计所有配置更改
- **特性**：
  - 配置表的版本控制
  - 每个配置更改的生效自"时间戳
  - 配置快照存储与报告\n  - 配置更改审计日志
  - 回滚到先前配置版本的能力
- **端点**：\n  - GET /config/versions：列出所有配置版本\n  - GET /config/version/:id：检索特定配置版本\n  - GET /config/audit：检索配置更改审计日志
  - POST /config/rollback/:id：回滚到特定配置版本
\n### 2.24 边缘案例检测作为信号质量\n- **功能**：检测并标记边缘案例为低置信度信号机制，而非错误
- **退化行为模式**：
  - 恒定零值：标记为低信号机制
  - 完美周期性：标记为潜在机器人活动信号
  - 不可能的规律性：标记为异常信号模式
- **处理**：边缘案例是信号，而非错误。它们表示低置信度机制，应作为信号质量指标呈现
- **输出**：信号质量评分和边缘案例标志包含在所有分析响应中
- **集成**：信号质量指标显示在仪表板中并包含在 API 响应中

### 2.25 系统性异常检测
- **功能**：检测并标记与卖家分析分离的系统性问题
- **系统性异常类型**：
  - 突然模式更改：检测意外的数据结构更改
  - 时间戳漂移：识别时钟同步问题
  - 摄取突发：检测异常数据摄取模式
- **处理**：标记系统健康问题而不污染卖家分析
- **输出**：单独的系统健康指标和警报
- **端点**：GET /system/health 查询系统性异常状态
- **仪表板集成**：与卖家分析分离的系统健康面板

### 2.26 前端着陆页\n- **功能**：展示 Lush Analytics 平台的简洁现代着陆页
- **部分**：
  - **英雄区**：\n    - 标题：主要价值主张
    - 副标题：支持描述
    - 行动号召按钮：打开用户交互对话框
  - **功能区**：
    - 带图标的四个功能卡\n    - 突出关键平台能力
    - **异常检测框**：引用高级数学模型（不提及 AI 或机器学习）
    - **预测洞察框**：引用高级数学模型（不提及 AI 或机器学习）
  - **定价区**：
    - 四个定价层级，清晰区分：
      - 免费层级：€0\n      - 基础层级：€50
      - 高级层级：€300\n      - 商业层级：€1200
    - 以欧元符号（€）显示定价
  - **推荐区**：
    - 客户推荐和成功案例
  - **电子邮件注册表单**：
    - 新闻通讯订阅或早期访问注册\n- **对话框行为**：
  - 可通过单击取消按钮关闭对话框
  - 可通过单击对话框外部任何位置关闭对话框
- **响应式设计**：针对桌面和移动设备优化的完全响应式布局
- **样式**：与现有应用程序样式和设计系统一致
\n### 2.27 用户身份验证系统
- **功能**：安全的用户身份验证和授权\n- **特性**：\n  - 使用电子邮件和密码进行用户注册
  - 使用电子邮件和密码进行用户登录
  - 密码重置功能
  - 会话管理
  - 基于 JWT 令牌的身份验证\n  - **注册后重定向**：成功注册后，用户被重定向到仪表板页面
- **端点**：
  - POST /auth/register：用户注册
  - POST /auth/login：用户登录
  - POST /auth/logout：用户注销
  - POST /auth/reset-password：密码重置请求
  - POST /auth/confirm-reset：确认密码重置\n\n### 2.28 团队管理系统
- **功能**：具有基于角色的访问控制的团队协作
- **角色**：
  - **管理员**：完整的团队管理权限
    - 邀请新成员加入团队
    - 从团队中删除成员
    - 管理团队设置
    - 创建和管理项目
    - 将任务分配给团队成员
  - **成员**：有限权限\n    - 查看团队设置（只读）
    - 查看项目和任务\n    - 更新分配的任务
    - 无法邀请/删除成员
    - 无法修改团队设置
- **特性**：
  - 团队创建\n  - 通过电子邮件邀请成员
  - 管理员删除成员
  - 角色分配和管理
  - 团队设置管理（仅管理员）
- **端点**：
  - POST /teams：创建新团队
  - GET /teams/:teamId：获取团队详细信息
  - POST /teams/:teamId/invite：邀请成员（仅管理员）
  - DELETE /teams/:teamId/members/:userId：删除成员（仅管理员）
  - GET /teams/:teamId/members：列出团队成员
  - PUT /teams/:teamId/settings：更新团队设置（仅管理员）
\n### 2.29 项目管理系统
- **功能**：在团队上下文中创建和管理项目
- **特性**：
  - 在团队上下文中创建项目
  - 项目详细信息（名称、描述、创建日期）
  - 项目所有权和访问控制
  - 列出团队的所有项目
- **权限**：
  - 所有团队成员可以查看项目
  - 管理员可以创建和管理项目
- **端点**：
  - POST /teams/:teamId/projects：创建新项目
  - GET /teams/:teamId/projects：列出所有项目
  - GET /projects/:projectId：获取项目详细信息
  - PUT /projects/:projectId：更新项目（仅管理员）
  - DELETE /projects/:projectId：删除项目（仅管理员）
\n### 2.30 具有实时更新的任务管理系统
- **功能**：具有实时同步的任务创建、分配和跟踪
- **任务属性**：
  - **title**：任务标题（必填）
  - **description**：任务描述（可选）
  - **status**：任务状态（必填）
    - todo：任务未开始
    - in progress：任务正在进行中
    - completed：任务已完成
  - **assigned user**：分配给任务的用户（可选）
  - **created date**：任务创建时间戳\n  - **updated date**：任务最后更新时间戳\n- **特性**：
  - 在项目中创建任务
  - 将任务分配给团队成员
  - 更新任务状态
  - 更新任务详细信息（标题、描述）
  - 重新分配任务\n  - 使用 Supabase Realtime 进行实时任务更新
  - 按状态过滤任务
  - 按分配用户过滤任务
- **实时同步**：\n  - 任务状态更改实时广播给所有团队成员
  - 任务分配在所有连接的客户端上即时更新
  - 任务更新（标题、描述）立即同步
- **端点**：
  - POST /projects/:projectId/tasks：创建新任务
  - GET /projects/:projectId/tasks：列出项目的所有任务
  - GET /tasks/:taskId：获取任务详细信息
  - PUT /tasks/:taskId：更新任务\n  - DELETE /tasks/:taskId：删除任务
  - PUT /tasks/:taskId/status：更新任务状态
  - PUT /tasks/:taskId/assign：将任务分配给用户\n\n### 2.31 仪表板任务分析
- **功能**：在仪表板上显示任务完成进度和分配的任务
- **特性**：
  - **任务完成进度**：\n    - 分配给当前用户的所有任务的总体完成百分比
    - 显示完成率的视觉进度条
    - 按状态分解（todo、in progress、completed）\n  - **分配任务概览**：
    - 分配给当前用户的所有任务列表
    - 任务状态指标（彩色徽章）
    - 快速任务状态更新功能
    - 按状态过滤任务
    - 按创建日期或截止日期排序任务
- **实时更新**：任务分析随任务修改实时更新
- **端点**：GET /dashboard/tasks/analytics\n\n### 2.32 Stripe 支付集成
- **功能**：定价层级订阅的支付处理
- **特性**：
  - Stripe Checkout 集成用于订阅支付
  - 支持所有定价层级（免费、基础、高级、商业）
  - 订阅管理（升级、降级、取消）
  - 支付方式管理\n  - 发票生成和历史记录
  - 支付事件的 Webhook 处理
  - 基于订阅状态的自动层级访问控制
  - **支付通知**：显示指示支付成功或失败的通知\n  - **通知自动关闭**：通知在 5 秒后自动消失
- **支付流程**：
  1. 用户选择定价层级
  2. 重定向到 Stripe Checkout
  3. 用户完成支付
  4. Webhook 确认支付
  5. 显示成功/失败通知（5 秒后自动关闭）
  6. 用户层级自动更新
  7. 授予层级特定功能的访问权限
- **端点**：
  - POST /billing/checkout：创建 Stripe Checkout 会话
  - POST /billing/portal：创建 Stripe 客户门户会话
  - POST /billing/webhook：处理 Stripe webhook 事件
  - GET /billing/subscription：获取当前订阅详细信息
  - POST /billing/cancel：取消订阅

### 2.33 Webhook 注册与管理
- **功能**：Webhook 作为已计算事实的交付机制，而非触发器
- **核心原则**：Webhook 是洞察状态变化的副作用，从不作为输入
- **安全事件类型**：
  - anomaly_detected：检测到异常\n  - alert_triggered：触发警报\n  - prediction_updated：更新预测
  - insight_state_changed：洞察状态变化
  - weekly_report_ready：每周报告准备就绪
  - pricing_tier_changed：定价层级变化
- **Webhook 负载要求**：
  所有 Webhook 负载必须包含：
  - reproducibilityHash：可重现性哈希
  - configVersion：配置版本
  - timeWindow：时间窗口
  - dataSufficiency：数据充分性
  - signalQuality：信号质量
- **防护栏**：
  - **异步 + 尽力而为交付**：Webhook 交付是异步的，采用尽力而为策略
  - **重试与退避**：交付失败时使用退避策略重试
  - **死信队列**：持续失败的 Webhook 进入死信队列
  - **交付失败不影响分析**：Webhook 交付失败从不影响分析计算
  - **禁止触发重新计算**：Webhook 不能触发重新计算，仅观察状态转换
  - **禁止从 DSP 循环内发出**：Webhook 从不从 DSP 循环内部发出
  - **确定性排序**：如果两个洞察在同一窗口内发生，排序必须定义（时间戳 + 类型优先级）
- **端点**：
  - POST /webhooks：注册新 Webhook
  - GET /webhooks：列出所有已注册的 Webhook
  - GET /webhooks/:id：获取 Webhook 详细信息\n  - PUT /webhooks/:id：更新 Webhook 配置
  - DELETE /webhooks/:id：删除 Webhook\n  - GET /webhooks/:id/deliveries：查看 Webhook 交付历史\n  - POST /webhooks/:id/test：测试 Webhook 交付

### 2.34 漏斗分析
- **功能**：漏斗是事件类型的聚合\n- **核心原则**：\n  - 漏斗是确定性的
  - 漏斗是可重现的
  - 漏斗是可解释的
- **设计决策**：
  - **声明式**：漏斗必须是声明式的
  - **配置支持**：漏斗定义存储在集中配置中
  - **窗口绑定**：漏斗必须绑定到时间窗口
- **API 形状**：
  - **预定义漏斗模板**：每个层级的预定义漏斗模板
  - **卖家可选但受约束的步骤集**：卖家可以选择步骤，但受约束
  - **集中配置**：\n    - 最小数据要求
    - 步骤排序规则
    - 步骤之间的超时\n- **约束**：
  - **步骤必须在时间上单调**：步骤必须按时间顺序排列\n  - **漏斗窗口必须与环形缓冲区窗口对齐**：漏斗窗口必须与环形缓冲区窗口对齐
  - **漏斗输出始终包含**：\n    - 流失归因：每个步骤的流失原因分析
    - 每步充分性：每个步骤的数据充分性指标
    - 置信度消息传递：基于数据质量的置信度消息\n- **端点**：
  - GET /funnels/templates：列出预定义漏斗模板
  - POST /funnels：创建自定义漏斗（受约束）
  - GET /funnels/:id：获取漏斗详细信息
  - GET /funnels/:id/analysis：执行漏斗分析\n  - GET /metrics/:seller/funnels：获取卖家的漏斗分析结果
- **响应格式**：
  - steps：漏斗步骤数组
  - conversionRates：每步转化率
  - dropOffAttribution：流失归因分析
  - dataSufficiency：每步数据充分性
  - confidenceMessage：置信度消息
  - timeWindow：时间窗口定义
  - reproducibilityHash：可重现性哈希
  - configVersion：配置版本
  - signalQuality：信号质量评估
\n## 3. 技术架构

### 3.1 数据处理\n- 用于实时数据存储的预分配固定大小连续环形缓冲区
- 索引模窗口大小进行循环访问\n- 每事件零重新分配，无每事件对象流失
- 流式分析处理
- DSP 算法集成（FIR、FFT、HFD）
- 高吞吐量场景的批处理支持
- 具有固定随机种子和一致排序的确定性计算管道
- **聚合优先**：所有分析都在聚合数据上操作，从不在原始单个事件上操作

### 3.2 具有时间局部性的缓存策略
- 概率缓存机制\n- **lastComputedAt** 时间戳跟踪
- 仅在查询时进行概率刷新
- 动态 TTL 调整（在集中配置中定义）
- 热/冷数据区分
- 用于频繁访问计算的短期缓存层
\n### 3.3 API 设计
- RESTful API 架构
- 实时事件摄取
- 批量摄取端点
- 按需指标查询
- 类型安全实现（无 any 转换）
- 用于异常和预测结果的专用销售端点
- 决策钩子集成点
- 一键导出端点
- 可审计配置端点
- 系统健康端点
- 用户身份验证端点
- 团队管理端点
- 项目管理端点\n- 任务管理端点
- 计费和支付端点
- Webhook 管理端点
- 漏斗分析端点\n\n### 3.4 仪表板组件
- 模式切换功能（浅色/深色主题）
- 具有正确时间戳处理的时间序列图表：
  - 内部数字时间戳
  - 工具提示和轴刻度中的格式化显示
  - 历史数据和预测数据之间的清晰视觉分离
  - 多日数据跨度的非重叠标签
- 置信带可视化（预测周围的 ± 带）
- 实时警报通知
- 带分页/无限滚动的事件日志
- **时间窗口显示面板**：显示当前分析的开始时间、结束时间、窗口大小
- **数据充分性指标**：视觉指标（进度条、状态徽章）显示数据完整性
- **速率限制与背压仪表板**：显示当前速率限制状态、剩余配额、背压指标、队列深度可视化
- **置信度与充分性感知消息传递**：解释结果可靠性的上下文消息\n- **可嵌入组件支持**：可嵌入小部件的集成
- **洞察生命周期可视化**：显示洞察状态及视觉指标和状态转换历史
- **配置版本显示**：显示正在使用的当前配置版本
- **信号质量指标**：显示边缘案例标志和退化模式警告
- **系统健康面板**：用于系统性异常监控的单独面板
- **任务完成进度小部件**：显示当前用户的总体任务完成百分比\n- **分配任务小部件**：显示分配给当前用户的任务列表及状态指标和快速更新功能
\n### 3.5 实时集成
- Supabase Realtime 用于实时数据流\n- 用于仪表板更新的 WebSocket 连接
- AnomalyAlert 组件集成
- 实时任务更新和同步
- 实时团队协作功能
\n### 3.6 报告与定价系统
- 自动化每周报告生成引擎
- 警报驱动的定价层级计算逻辑（数据驱动，非基于逻辑）
- 报告交付系统（电子邮件、通知、API）
- 定价层级 API 端点
- 一键导出功能集成
- 每个报告的配置快照存储
\n### 3.7 确定性可重现性系统
- 固定随机种子管理
- 确定性排序和计算顺序
- 用于验证的可重现性哈希生成
- 用于审计跟踪的输入/输出日志记录
- **系统不变量**：确定性保证 - 相同输入始终产生相同输出
\n### 3.8 集中配置系统
- **集中配置存储**：所有系统参数的单一真实来源
- **配置参数**：
  - 窗口大小（环形缓冲区大小、分析窗口大小）
  - 阈值（异常分数阈值、置信度截止值、信号质量阈值）\n  - TTL（热卖家 TTL、冷卖家 TTL、缓存 TTL）
  - 层级限制（每层级警报频率限制、每层级功能访问）
  - 置信度截止值（预测的最小置信度、最小数据充分性）
  - 警报级别（由配置表定义，而非条件语句）
  - 采样率（高/中/低活动采样率）
  - 每层级嵌入速率限制
  - 每层级保留策略
  - 边缘案例检测阈值
  - 漏斗模板定义
  - Webhook 重试策略
- **动态表达式**：在适用的地方使用动态表达式，避免魔术数字
- **数据驱动设计**：警报级别、层级、阈值均由配置数据定义，而非硬编码逻辑
- **版本控制**：所有配置更改都带有时间戳的版本\n- **审计跟踪**：配置更改的完整审计日志
\n### 3.9 模块化和可组合架构
- **可组合性焦点**：为可组合性而非重用而设计
- **模块化组件**：DSP、缓存、警报、报告、导出、嵌入、配置管理、洞察生命周期、边缘案例检测、系统性异常检测、身份验证、团队管理、项目管理、任务管理、计费、Webhook 管理、漏斗分析的单独模块
- **简洁重构**：消除冗余，集中通用逻辑
- **零魔术数字**：所有常量在集中配置中定义
\n### 3.10 数据最小化和隐私架构
- **硬不变量**：分析路径中无姓名、电子邮件、地址\n- **卖家 ID**：始终是不透明/代理键，从不是直接标识符
- **事件负载**：仅剥离为行为信号，无 PII\n- **聚合优先**：所有分析都在聚合数据上操作\n- **数据最小化执行**：自动检查以防止 PII 泄漏
\n### 3.11 保留策略系统
- **基于层级的保留**：在集中配置中按定价层级定义保留期
- **明确到期窗口**：所有数据的清晰到期时间戳
- **自动衰减**：基于保留策略的自动数据删除
- **保留层级**：\n  - 免费层级：30 天保留
  - 基础层级：60 天保留
  - 高级层级：90 天保留
  - 商业层级：365 天保留（可自定义）
- **策略执行**：保留作为策略，而非配置 - 在系统级别执行
\n### 3.12 系统不变量（编码化）
- **确定性保证**：相同输入始终产生相同输出
- **无静默重新计算**：所有重新计算都被记录和审计
- **无隐藏阈值**：所有阈值在集中配置中定义\n- **所有警报引用数据充分性**：每个警报必须包含数据充分性状态
- **数据最小化**：分析路径中无 PII，卖家 ID 始终不透明，事件负载仅剥离为行为信号
- **聚合优先**：所有分析都在聚合数据上操作，从不在原始单个事件上操作
- **边缘案例作为信号**：边缘案例被视为低置信度信号机制，而非错误
- **系统性异常分离**：系统健康问题与卖家分析分开标记
- **Webhook 作为副作用**：Webhook 是洞察状态变化的副作用，从不作为输入
- **漏斗确定性**：漏斗分析必须是确定性和可重现的

### 3.13 加密策略
- **静态加密**：\n  - 事件存储：加密\n  - 配置表：加密
  - 报告：加密
  - 使用日志：加密
  - 用户凭据：加密
  - 团队数据：加密
  - 项目数据：加密
  - 任务数据：加密
  - Webhook 配置：加密
- **传输中加密**：
  - API 流量：TLS 无处不在，无例外
  - 小部件嵌入：需要 TLS\n  - Webhook：需要 TLS
  - 实时连接：需要 TLS\n- **秘密与密钥管理**：
  - API 密钥：加密、可轮换、作用域、可撤销
  - Webhook 秘密：加密、可轮换、作用域、可撤销
  - 嵌入令牌：加密、可轮换、作用域、可撤销
  - Stripe API 密钥：加密、可轮换\n- **未加密**：
  - 派生分析：未加密（聚合、非敏感）
  - 聚合指标：未加密（聚合、非敏感）\n  - 分数：未加密（聚合、非敏感）
- **密钥轮换**：在集中配置中定义的自动密钥轮换策略
- **访问控制**：加密数据的基于角色的访问控制

### 3.14 前端架构
- **技术栈**：React + Tailwind CSS + Shadcn\n- **组件结构**：模块化、可重用组件
- **响应式设计**：移动优先方法，带桌面断点
- **对话框组件**：用于行动号召交互的 HTML 对话框元素
  - **对话框关闭行为**：可通过单击取消按钮或单击对话框外部关闭对话框
- **样式一致性**：维护现有应用程序设计系统和样式模式
- **可访问性**：符合 WCAG，支持键盘导航\n- **性能**：优化加载，图像和组件的延迟加载
\n### 3.15 身份验证与授权架构
- **身份验证方法**：基于 JWT 令牌的身份验证\n- **会话管理**：带令牌刷新的安全会话处理
- **基于角色的访问控制（RBAC）**：
  - 管理员角色：完整权限\n  - 成员角色：有限权限
- **权限执行**：所有受保护端点的服务器端权限检查
- **令牌安全**：用于令牌存储的 HTTP-only cookie，CSRF 保护
- **注册后流程**：成功注册后将用户重定向到仪表板页面
\n### 3.16 团队协作架构
- **多租户**：基于团队的数据隔离
- **实时协作**：Supabase Realtime 用于实时团队更新
- **访问控制**：团队级和项目级访问控制
- **邀请系统**：带安全令牌的基于电子邮件的成员邀请
\n### 3.17 支付处理架构
- **支付网关**：Stripe 集成\n- **订阅管理**：Stripe Subscriptions API
- **Webhook 处理**：带签名验证的安全 Webhook 处理\n- **层级访问控制**：基于订阅层级的自动功能访问\n- **支付安全**：符合 PCI DSS 的支付处理（由 Stripe 处理）
- **支付通知**：显示带 5 秒自动关闭的成功/失败通知

### 3.18 Webhook 架构
- **异步交付**：Webhook 交付是异步的，不阻塞主分析流程
- **重试机制**：带指数退避的重试策略
- **死信队列**：持续失败的 Webhook 进入死信队列进行手动审查
- **交付日志**：完整的 Webhook 交付历史和状态跟踪
- **签名验证**：所有 Webhook 负载都使用 HMAC 签名进行验证
- **速率限制**：每个 Webhook 端点的速率限制以防止滥用

### 3.19 漏斗分析架构
- **声明式定义**：漏斗在集中配置中声明式定义
- **模板系统**：每个层级的预定义漏斗模板
- **步骤约束**：步骤必须在时间上单调，窗口必须对齐
- **充分性检查**：每个步骤的数据充分性验证
- **流失归因**：每个步骤的详细流失原因分析
- **确定性计算**：漏斗分析必须是确定性和可重现的

## 4. 系统特性
- 轻量级和优雅的设计
- 高性能和可扩展性
- 实时处理能力
- 具有时间局部性的智能缓存优化
- 自适应资源管理
- 全面的分析和洞察\n- 类型安全实现
- 具有实时更新的增强用户体验
- 确定性和可重现的异常检测
- 清晰的时间窗口定义和数据充分性指标
- 速率限制和背压可见性
- 用于自定义业务逻辑的可扩展决策钩子
- 带洞察摘要的自动化每周健康报告
- 具有固定默认值的动态警报驱动定价层级
- 用于销售异常和预测结果的专用端点
- 一键导出功能（PDF/电子邮件）
- 用于外部集成的可嵌入组件及软防护栏
- 全面的置信度和充分性感知消息传递
- 数据驱动的配置系统（无魔术数字，无硬编码逻辑）
- 模块化和可组合架构
- 具有预分配环形缓冲区和零每事件流失的高效数据移动
- 具有上下文信息的警报单一主要触发器
- 具有版本控制和快照的可审计配置管理
- 具有状态管理的形式化洞察生命周期
- 作为硬不变量的数据最小化和隐私执行
- 聚合优先分析方法
- 具有自动衰减的基于层级的保留策略
- 用于一致性和可靠性的编码化系统不变量
- 边缘案例检测作为信号质量指标
- 与卖家分析分离的系统性异常检测\n- 全面的加密策略（静态、传输中、秘密与密钥）
- 具有简洁设计和直观用户体验的现代响应式前端
- 安全的用户身份验证和授权
- 具有管理员/成员角色的基于角色的团队协作
- 实时任务管理和同步
- 带完成进度和分配任务概览的仪表板任务分析
- 集成的 Stripe 支付处理及成功/失败通知
- Webhook 注册与管理，作为洞察状态变化的副作用
- 声明式、确定性、可重现的漏斗分析
\n## 5. 系统宪章
\n### 5.1 目的和范围
本系统宪章定义了管理 Lush Analytics 平台的基本原则、不变量和治理规则。它作为所有系统设计、实施和运营决策的权威参考。所有系统组件、模块和行为必须符合此处阐述的原则和不变量。

### 5.2 核心原则
\n#### 5.2.1 确定性和可重现性
系统保证确定性行为：相同的输入必须始终产生相同的输出。此原则确保可审计性、可调试性和信任。所有计算使用固定随机种子、确定性排序和一致排序。为所有分析输出生成可重现性哈希以启用验证。

#### 5.2.2 数据最小化和隐私设计
系统将严格的数据最小化作为硬不变量执行。任何个人身份信息（PII），如姓名、电子邮件或地址，都不得进入分析路径。卖家标识符始终是不透明的代理键。事件负载仅剥离为行为信号。所有分析都在聚合数据上操作，从不在原始单个事件上操作。此原则是不可协商的，并在架构级别执行。

#### 5.2.3 透明度和可解释性
系统为其决策过程提供完全透明度。所有分析输出包括清晰的时间窗口定义、数据充分性指标、置信度消息传递、信号质量评估和配置版本引用。用户必须了解系统知道什么、不知道什么以及对其输出的置信度。

#### 5.2.4 配置作为单一真实来源
所有系统参数、阈值和行为都在集中配置系统中定义。不允许魔术数字或硬编码逻辑。配置更改是版本化、带时间戳和可审计的。此原则确保一致性、可维护性和治理。

#### 5.2.5 可组合性优于可重用性
系统在其架构中优先考虑可组合性。模块被设计为组合和扩展，而不仅仅是重用。此原则实现灵活性、适应性和长期可维护性。

#### 5.2.6 边缘案例作为信号，而非错误
系统将边缘案例（恒定零值、完美周期性、不可能的规律性）视为低置信度信号机制，而非错误或错误。边缘案例作为信号质量指标呈现，提供有关数据质量和行为模式的有价值信息。
\n#### 5.2.7 关注点分离：卖家分析与系统健康\n卖家分析和系统性异常严格分离。系统健康问题（模式更改、时间戳漂移、摄取突发）独立标记，不污染卖家级分析。这种分离确保清晰度并防止卖家面向输出中的误报。

#### 5.2.8 Webhook 作为副作用\nWebhook 是洞察状态变化的副作用，从不作为输入。Webhook 仅观察已计算的事实，从不触发重新计算。此原则保持确定性和可审计性。

#### 5.2.9 漏斗确定性
漏斗分析必须是确定性和可重现的。漏斗在集中配置中声明式定义，步骤必须在时间上单调，窗口必须对齐。此原则确保漏斗分析的可靠性和可审计性。

### 5.3 系统不变量

以下不变量在系统级别编码和执行。违反这些不变量构成系统故障，必须通过设计防止：

1. **确定性保证**：相同输入始终产生相同输出。
2. **无静默重新计算**：所有重新计算都被记录和审计。
3. **无隐藏阈值**：所有阈值在集中配置中定义。
4. **所有警报引用数据充分性**：每个警报必须包含数据充分性状态。
5. **数据最小化**：分析路径中无 PII；卖家 ID 始终不透明；事件负载仅剥离为行为信号。\n6. **聚合优先**：所有分析都在聚合数据上操作，从不在原始单个事件上操作。\n7. **边缘案例作为信号**：边缘案例被视为低置信度信号机制，而非错误。
8. **系统性异常分离**：系统健康问题与卖家分析分开标记。
9. **Webhook 作为副作用**：Webhook 是洞察状态变化的副作用，从不作为输入。
10. **漏斗确定性**：漏斗分析必须是确定性和可重现的。

### 5.4 治理和变更管理

对系统宪章的所有更改都需要正式审查和批准。配置更改是版本化和可审计的。系统不变量在任何情况下都不得违反。此治理框架确保稳定性、信任和长期系统完整性。

## 6. 公共信任与安全声明

### 6.1 我们对信任和安全的承诺

Lush Analytics 建立在信任、透明度和安全的基础上。我们认识到我们的用户委托我们处理敏感的行为数据，我们认真对待这一责任。本公共信任与安全声明阐述了我们的承诺以及我们为保护用户数据和维护系统完整性而实施的措施。

### 6.2 数据隐私和最小化\n
我们将严格的数据最小化作为核心架构原则执行。在分析路径中不收集、存储或处理任何个人身份信息（PII），如姓名、电子邮件或地址。卖家标识符始终是不透明的代理键，确保匿名性。事件负载仅剥离为行为信号，所有分析都在聚合数据上操作。这种方法最大限度地降低隐私风险，并确保符合数据保护法规。

### 6.3 加密和数据保护

我们采用全面的加密策略来保护静态和传输中的数据：

- **静态**：事件存储、配置表、报告、使用日志、用户凭据、团队数据、项目数据、任务数据和 Webhook 配置使用行业标准加密算法加密。
- **传输中**：所有 API 流量、小部件嵌入、Webhook 和实时连接无一例外地使用 TLS 加密。
- **秘密与密钥**：API 密钥、Webhook 秘密、嵌入令牌和 Stripe API 密钥是加密、可轮换、作用域和可撤销的。执行自动密钥轮换策略。
\n派生分析、聚合指标和分数未加密，因为它们在设计上是聚合和非敏感的。

### 6.4 确定性和可审计性

我们保证确定性行为：相同的输入始终产生相同的输出。这确保了可审计性、可调试性和信任。所有计算都被记录，并生成可重现性哈希以进行验证。配置更改是版本化和可审计的，提供完整的审计跟踪。

### 6.5 透明度和可解释性\n
我们为我们的决策过程提供完全透明度。所有分析输出包括清晰的时间窗口定义、数据充分性指标、置信度消息传递、信号质量评估和配置版本引用。用户始终知道系统知道什么、不知道什么以及对其输出的置信度。

### 6.6 保留和数据生命周期\n
我们执行具有明确到期窗口的基于层级的保留策略。数据根据保留策略自动删除，确保符合数据保护法规并最大限度地降低长期存储风险。保留期清楚地传达并在系统级别执行。

### 6.7 安全事件响应

我们维护正式的安全事件响应计划。在发生安全事件时，我们将及时调查、缓解并与受影响的用户沟通。我们致力于持续改进并从安全事件中学习。\n
### 6.8 合规性和认证

我们致力于遵守相关的数据保护法规，包括 GDPR 和 CCPA。我们持续监控法规发展并相应调整我们的做法。

### 6.9 联系和问责

对于安全问题、疑问或事件报告，用户可以通过 security@lushanalytics.com 联系我们的安全团队。我们对用户负责，并致力于维护他们的信任。

## 7. 信号语义词汇表

本词汇表定义了整个系统中使用的关键术语的精确含义。这些定义是权威的，必须在所有系统组件、文档和面向用户的界面中一致应用。

### 7.1 异常\n
**定义**：异常是与预期行为模式的统计显著偏差，量化为 [0, 1] 范围内的概率分数。异常分数为 0 表示无偏差；分数为 1 表示最大偏差。
\n**组成**：异常分数使用以下内容的贝叶斯/概率组合计算：
- **FFT 峰值贡献**：通过快速傅里叶变换分析检测到的周期性峰值。
- **HFD 复杂性贡献**：通过 Higuchi 分形维数测量的时间序列复杂性。
- **趋势偏差贡献**：与平滑趋势线的偏差。
- **平滑偏差贡献**：与 FIR 平滑基线的偏差。
\n**解释**：异常表示潜在问题，如机器人活动、销售峰值或异常行为模式。它们是调查的信号，而非明确的诊断。

**归因**：所有异常输出包括根本原因分解，显示每个组件对总体异常分数的百分比贡献。

### 7.2 置信度

**定义**：置信度是系统对其输出的确定性的度量，表示为定性或定量指标。置信度取决于数据充分性、信号质量和计算稳定性。

**影响置信度的因素**：
- **数据充分性**：可靠分析需要足够的数据点。数据不足会降低置信度。
- **信号质量**：高信号质量（低噪声、无退化模式）增加置信度。低信号质量（边缘案例、退化模式）降低置信度。
- **计算稳定性**：确定性、可重现的计算增加置信度。非确定性或不稳定的计算降低置信度。

**置信度消息传递**：所有分析输出包括置信度感知消息传递，根据数据质量和充分性解释结果的可靠性。

**置信带**：预测包括预测值周围的置信带（± 区间），可视化不确定性。

### 7.3 充分性

**定义**：充分性是系统是否有足够数据来产生可靠分析的二元或分级指标。充分性通过将可用数据点数量与给定分析所需的最小数据点进行比较来确定。\n
**充分性指标**：
- **充分**：系统有足够的数据来产生可靠的分析。
- **不充分**：系统没有足够的数据。分析可能不可靠或不可用。
\n**充分性阈值**：最小数据点要求在集中配置中定义，并因分析类型（异常检测、预测、健康评分等）而异。

**充分性消息传递**：所有分析输出包括数据充分性指标和消息传递，解释是否有足够的数据以及需要多少数据点与可用数据点。

**系统不变量**：所有警报必须引用数据充分性状态。基于不充分数据的警报必须清楚地标记。

### 7.4 信号质量

**定义**：信号质量是对输入数据的可靠性和可解释性的评估。高信号质量表示干净、一致和可解释的数据。低信号质量表示嘈杂、不一致或退化的数据模式。

**信号质量指标**：\n- **退化模式**：恒定零值、完美周期性、不可能的规律性。这些模式被标记为低置信度信号机制。
- **边缘案例标志**：异常或边界案例数据模式的指标。
- **噪声水平**：数据噪声和可变性的评估。
\n**处理**：信号质量指标在所有分析输出中呈现。低信号质量降低置信度，并通过置信度感知消息传递传达给用户。

**理念**：边缘案例和退化模式被视为信号，而非错误。它们提供有关数据质量和行为模式的有价值信息。

### 7.5 时间窗口

**定义**：时间窗口是计算分析的时间范围。时间窗口由开始时间戳、结束时间戳和窗口大小（持续时间）定义。

**清晰度要求**：所有分析输出必须包括清晰的时间窗口定义，确保用户了解分析的时间范围。
\n**环形缓冲区对齐**：时间窗口与环形缓冲区结构对齐，确保高效和一致的数据访问。

### 7.6 可重现性哈希

**定义**：可重现性哈希是从用于产生分析输出的输入和配置生成的加密哈希值。它启用确定性验证：相同的输入和配置将始终产生相同的哈希。

**目的**：可重现性哈希确保可审计性和信任。用户可以验证分析输出是确定性的，并且没有被篡改。

**包含**：所有分析输出包括可重现性哈希。

### 7.7 配置版本

**定义**：配置版本是集中配置系统特定版本的唯一标识符。配置版本带有时间戳并可审计。

**目的**：配置版本确保分析输出可以追溯到用于产生它们的确切配置。这启用可重现性、可审计性和调试。

**包含**：所有分析输出包括用于计算的配置版本。
\n### 7.8 洞察生命周期状态

**定义**：洞察生命周期状态是自动生成洞察的当前状态。洞察根据时间、数据更新和用户反馈在状态之间转换。

**状态**：
- **Generated**：新创建的洞察。
- **Confirmed**：由后续数据或用户操作验证的洞察。
- **Expired**：由于时间流逝而不再相关的洞察。
- **Superseded**：被更新、更准确的洞察取代的洞察。

**目的**：洞察生命周期状态提供上下文和相关性，帮助用户了解洞察的当前有效性和适用性。

### 7.9 系统性异常\n
**定义**：系统性异常是影响系统本身而非卖家级行为的问题。系统性异常包括模式更改、时间戳漂移和摄取突发。

**分离**：系统性异常与卖家分析分开标记，确保清晰度并防止卖家面向输出中的误报。

**监控**：系统性异常通过专用系统健康端点和仪表板面板进行监控。
\n### 7.10 Webhook\n
**定义**：Webhook 是洞察状态变化的副作用，从不作为输入。Webhook 仅观察已计算的事实，从不触发重新计算。

**事件类型**：
- anomaly_detected：检测到异常\n- alert_triggered：触发警报
- prediction_updated：更新预测\n- insight_state_changed：洞察状态变化
- weekly_report_ready：每周报告准备就绪
- pricing_tier_changed：定价层级变化

**负载要求**：所有 Webhook 负载必须包含 reproducibilityHash、configVersion、timeWindow、dataSufficiency 和 signalQuality。

**交付保证**：Webhook 交付是异步和尽力而为的。交付失败从不影响分析计算。

### 7.11 漏斗\n
**定义**：漏斗是事件类型的聚合，用于分析用户在一系列步骤中的转化和流失。漏斗必须是确定性、可重现和可解释的。

**步骤约束**：
- 步骤必须在时间上单调（按时间顺序排列）
- 漏斗窗口必须与环形缓冲区窗口对齐
\n**输出要求**：漏斗输出始终包含流失归因、每步充分性和置信度消息传递。

**模板**：每个层级的预定义漏斗模板，卖家可选但受约束的步骤集。